<?php

require __DIR__ . '/../vendor/autoload.php';

use LightnCandy\LightnCandy;

genTestForClass('LightnCandy');
genTestForClass('Runtime');
genTestForClass('Context');
genTestForClass('Token');
genTestForClass('Parser');
genTestForClass('Validator');

function genTestForClass($classname) {
    ob_start();

    echo <<<VAR
<?php
/**
 * Generated by build/gen_test
 */
use LightnCandy\\LightnCandy;
use LightnCandy\\Runtime;

class {$classname}Test extends PHPUnit_Framework_TestCase
{

VAR
    ;

    $class = new \ReflectionClass("LightnCandy\\$classname");
    foreach ($class->getMethods() as $method) {
        if (preg_match_all('/@expect (.+) when input (.+)( after (.+))?/', $method->getDocComment(), $matched)) {
            echo <<<VAR
    /**
     * @covers LightnCandy\\{$classname}::{$method->name}
     */
    public function testOn_{$method->name}() {
        \$method = new \\ReflectionMethod('LightnCandy\\$classname', '{$method->name}');

VAR
            ;
            if ($method->isPrivate() || $method->isProtected()) {
                echo "        \$method->setAccessible(true);\n";
            }
            foreach ($matched[1] as $idx => $expect) {
                if ($matched[3][$idx]) {
                    echo "      {$matched[3][$idx]}\n";
                }
                echo "        \$this->assertEquals($expect, \$method->invokeArgs(null,array(\n            {$matched[2][$idx]}\n)        ));\n";
            }
            echo "    }\n";
        }
    }
    echo "}\n?>";

    $fn = "tests/{$classname}Test.php";
    if (!file_put_contents($fn, ob_get_clean())) {
        die("Can not generate tests into file $fn !!\n");
    }
}
?>
